function initDonut(){var a=[];a.push(new Promise(function(a,b){d3.csv("data/migration.csv",type,function(b,c){if(b)throw b;stateById=d3.map(),c.forEach(function(a){stateById.set(a.id,a)}),a()})})),a.push(new Promise(function(a,b){d3.csv("data/bli.csv",type,function(b,c){if(b)throw b;bliById=d3.map(),c.forEach(function(a){bliById.set(a.CountryCode,a)}),a()})})),a.push(new Promise(function(a,b){d3.tsv("http://www.oecdbetterlifeindex.org/bli/rest/indexes/stats/country",function(b,c){if(b)throw b;wmById=d3.map(),c.forEach(function(a){wmById.set(a.country,a)}),a()})})),Promise.all(a).then(function(){dispatch.load(stateById),location.hash.split("#")[1]?($(".outer, .inner").css("opacity",1),dispatch.statechange(stateById.get(countries.iso3[countries.iso2.indexOf(location.hash.split("#")[1])]))):($("#labels").hide(),$(".outer, .inner").css("pointer-events","none"),dispatch.statechange(stateById.get("AUS")))})}function initLabels(){groups.forEach(function(a){var b=$("<div class='label text' iso='"+countries.iso2[countries.iso3.indexOf(a)]+"' iso3='"+a+"'>"+countries.name[countries.iso3.indexOf(a)]+"<br/><span class='emigrants'></span><br/><span class='match'></span></div>");$("#labels").append(b)}),$(".label").mouseover(function(){$(".outer [iso3='"+$(this).attr("iso3")+"']").trigger("mouseover")}),$(".label").mouseout(function(){$(".outer [iso3='"+$(this).attr("iso3")+"']").trigger("mouseout")})}function type(a){return a.total=d3.sum(groups,function(b){return a[b]=+a[b]}),a}function addSpaces(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1 $2");return x1+x2}function angleToPos(a,b,c,d){return[d*Math.cos(c)+a,d*Math.sin(c)+b]}var dispatch=d3.dispatch("load","statechange"),bliCodes=["CG","SC","ES","EQ","HS","HO","IW","JE","SW","PS","WL"],groups=["AUS","AUT","BEL","CAN","CHL","CZE","EST","FIN","FRA","DEU","HUN","ISL","IRL","ISR","ITA","JPN","KOR","LUX","MEX","NLD","NZL","NOR","POL","PRT","SVK","SVN","ESP","SWE","CHE","GBR","USA","RUS"],stateById,bliById,wmById;$(window).on("hashchange",function(){location.hash.split("#")[1]&&dispatch.statechange(stateById.get(countries.iso3[countries.iso2.indexOf(location.hash.split("#")[1])]))}),dispatch.on("load.pie",function(a){var b=window.innerWidth,c=window.innerHeight,d=Math.min(.6*b,.6*c)/2,e=(d3.scale.ordinal().domain(groups).range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),d3.svg.arc().outerRadius(d-10).innerRadius(d-20)),f=d3.svg.arc().outerRadius(d-0).innerRadius(d-20),g=d3.layout.pie().sort(null),h=d3.layout.pie().sort(null),i=d3.select("body").append("svg").append("g").attr("class","inner").attr("transform","translate("+b/2+","+c/2+")"),j=d3.select("svg").append("g").attr("class","outer").attr("transform","translate("+b/2+","+c/2+")"),k=i.selectAll("path").data(groups).enter().append("path").style("fill","#152943").style("opacity",function(a){}).classed("donut",!0).attr("iso3",function(a){return a}).each(function(){this._current={startAngle:0,endAngle:0}}),l=j.selectAll("path").data(groups).enter().append("path").style("fill","#152943").style("opacity",function(){return.2+.8*Math.random()}).classed("donut",!0).attr("iso3",function(a){return a}).each(function(){this._current={startAngle:0,endAngle:0}});$(".outer .donut").mouseover(function(){$(this).css("fill-opacity","1"),$(".inner [iso3='"+$(this).attr("iso3")+"']").css("fill-opacity","0"),$(".inner [iso3='"+$(this).attr("iso3")+"']").css("stroke-opacity","0"),$("#labels .label").css("opacity",.2),$("#labels [iso3='"+$(this).attr("iso3")+"']").css({opacity:1,"z.index":200})}),$(".outer .donut").mouseout(function(){$(this).css("fill-opacity","0"),$(".inner [iso3='"+$(this).attr("iso3")+"']").css("fill-opacity","1"),$(".inner [iso3='"+$(this).attr("iso3")+"']").css("stroke-opacity","1"),$("#labels .label").css("opacity",1),$("#labels [iso='"+$(this).attr("iso3")+"']").css({"z.index":0})}),dispatch.on("statechange.pie",function(a){$(".label").css("opacity",0);var b=0;bliCodes.forEach(function(c){b+=parseFloat(wmById.get(a.id)[c])}),k.data(g.value(function(b){return a[b]})(groups)).style("opacity",function(c){var d=0;return bliCodes.forEach(function(e){d+=parseFloat(wmById.get(a.id)[e])/b*parseFloat(bliById.get(c.data)[e])}),1.25*(d/10-.1)}),l.data(g.value(function(b){return a[b]})(groups)).style("opacity",function(c){var d=0;return bliCodes.forEach(function(e){d+=parseFloat(wmById.get(a.id)[e])/b*parseFloat(bliById.get(c.data)[e])}),1.25*(d/10-.1)}),k.data(g.value(function(b){return a[b]})(groups)).transition().duration(800).attrTween("d",function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return e(b(a))}}),l.data(h.value(function(b){return a[b]})(groups)).transition().duration(400).attrTween("d",function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return f(b(a))}}).each("end",function(c){$("#labels").css({"pointer-events":"all",opacity:1});var e=c.endAngle-c.startAngle,f=$("#labels [iso='"+countries.iso2[countries.iso3.indexOf(c.data)]+"']");f.css("opacity",1);var g=0;if(bliCodes.forEach(function(d){g+=parseFloat(wmById.get(a.id)[d])/b*parseFloat(bliById.get(c.data)[d])}),g=(g/11*100).toFixed(1),f.children(".emigrants").html(addSpaces(Math.round(1e3*c.value))+" Emigrants"),f.children(".match").html(g+"% Match"),f.removeClass("center"),e>.3){var h=c.startAngle+e/2,i=[-150,-60];h<.5*Math.PI?i[0]=0:h<Math.PI?i[0]=i[1]=0:h<1.5*Math.PI&&(i[1]=0),h-=Math.PI/2;var j=angleToPos(window.innerWidth/2+i[0],window.innerHeight/2+i[1],h,d+10);f.css({left:Math.round(j[0])+"px",top:Math.round(j[1])+"px"}),f.addClass("center")}})}),$(".outer .donut").each(function(a,b){parseFloat($(b).attr("angledist"))>1&&$(b).css("fill-opacity","1")})});